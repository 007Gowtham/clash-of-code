generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String               @id @default(uuid())
  username           String?              @unique
  email              String               @unique
  password           String?
  googleId           String?              @unique
  isEmailVerified    Boolean              @default(false)
  role               Role                 @default(USER)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  lastLoginAt        DateTime?
  lastLoginIp        String?
  lockedUntil        DateTime?
  loginAttempts      Int                  @default(0)
  joinRequests       JoinRequest[]
  passwordResets     PasswordReset[]
  assignedQuestions  QuestionAssignment[]
  refreshTokens      RefreshToken[]
  ownedRooms         Room[]               @relation("RoomAdmin")
  roomParticipations RoomParticipant[]
  submissions        Submission[]
  leadingTeams       Team[]               @relation("TeamLeader")
  teamMemberships    TeamMember[]
  verificationCodes  VerificationCode[]

  @@index([email])
  @@index([googleId])
}

model VerificationCode {
  id        String   @id @default(uuid())
  userId    String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
}

model Room {
  id           String            @id @default(uuid())
  name         String
  code         String            @unique
  password     String?
  inviteLink   String            @unique
  adminId      String
  status       RoomStatus        @default(WAITING)
  startTime    DateTime?
  endTime      DateTime?
  duration     Int?
  settings     Json?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  listed       Boolean           @default(true)
  visibility   RoomVisibility    @default(PUBLIC)
  questions    Question[]
  admin        User              @relation("RoomAdmin", fields: [adminId], references: [id])
  events       RoomEvent[]

  participants RoomParticipant[]
  teams        Team[]
  
  // New Many-to-Many
  roomQuestions RoomQuestion[]

  @@index([code])
  @@index([adminId])
  @@index([visibility, status])
  @@index([status, listed])
}

model RoomParticipant {
  id       String            @id @default(uuid())
  roomId   String
  userId   String
  teamId   String?
  status   ParticipantStatus @default(ACTIVE)
  joinedAt DateTime          @default(now())
  leftAt   DateTime?
  room     Room              @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@index([roomId, status])
  @@index([userId, roomId])
}

model RoomEvent {
  id        String   @id @default(uuid())
  roomId    String
  type      String
  userId    String?
  data      Json?
  createdAt DateTime @default(now())
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId, createdAt])
}

model Team {
  id           String               @id @default(uuid())
  name         String
  roomId       String
  leaderId     String
  visibility   TeamVisibility       @default(PUBLIC)
  totalPoints  Int                  @default(0)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  code         String?
  joinRequests JoinRequest[]
  assignments  QuestionAssignment[]
  leader       User                 @relation("TeamLeader", fields: [leaderId], references: [id])
  room         Room                 @relation(fields: [roomId], references: [id], onDelete: Cascade)
  members      TeamMember[]

  @@index([roomId])
  @@index([leaderId])
  @@index([roomId, visibility])
  @@index([code])
}

model TeamMember {
  id       String   @id @default(uuid())
  teamId   String
  userId   String
  joinedAt DateTime @default(now())
  team     Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model JoinRequest {
  id        String            @id @default(uuid())
  teamId    String
  userId    String
  status    JoinRequestStatus @default(PENDING)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  team      Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model Question {
  id                String               @id @default(uuid())
  roomId            String?
  title             String
  description       String               @db.Text
  sampleInput       String               @db.Text
  sampleOutput      String               @db.Text
  points            Int                  @default(100)
  difficulty        String
  timeLimit         Int?                 @default(2000)
  memoryLimit       Int?                 @default(256)
  createdAt         DateTime             @default(now())
  functionName      String?
  functionSignature String?              @db.Text
  inputType         String?              @db.Text
  outputType        String?              @db.Text
  slug              String?              @unique
  
  // Metadata-driven wrapper generation fields
  inputFormats      Json?                // Array of input format specifications
  outputFormat      Json?                // Output format specification
  customTypes       Json?                // Custom type definitions
  
  constraints       Constraint[]
  hints             Hint[]
  room              Room?                @relation(fields: [roomId], references: [id], onDelete: Cascade)
  assignments       QuestionAssignment[]
  requests          QuestionRequest[]
  templates         QuestionTemplate[]
  submissions       Submission[]
  testCases         TestCase[]
  
  // New Many-to-Many relation via RoomQuestion
  involvedRooms     RoomQuestion[]

  @@index([roomId])
  @@index([slug])
}

model RoomQuestion {
  id         String   @id @default(uuid())
  roomId     String
  questionId String
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  
  room       Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([roomId, questionId])
  @@index([roomId])
  @@index([questionId])
}

model Hint {
  id         String   @id @default(uuid())
  questionId String
  content    String   @db.Text
  order      Int      @default(0)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

model Constraint {
  id         String   @id @default(uuid())
  questionId String
  content    String   @db.Text
  order      Int      @default(0)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

model TestCase {
  id          String            @id @default(uuid())
  questionId  String
  input       String            @db.Text
  output      String            @db.Text
  explanation String?           @db.Text
  isHidden    Boolean           @default(false)
  isSample    Boolean           @default(false)
  category    TestCaseCategory? @default(BASIC)
  memoryLimit Int?              @default(256)
  order       Int               @default(0)
  points      Int               @default(5)
  timeLimit   Int?              @default(2000)
  question    Question          @relation(fields: [questionId], references: [id], onDelete: Cascade)
  testResults TestCaseResult[]

  @@index([questionId])
  @@index([isSample])
  @@index([isHidden])
}

model QuestionAssignment {
  id           String         @id @default(uuid())
  questionId   String
  teamId       String
  userId       String?
  status       QuestionStatus @default(UNASSIGNED)
  assignedAt   DateTime?
  solvedAt     DateTime?
  pointsEarned Int            @default(0)
  createdAt    DateTime       @default(now())
  question     Question       @relation(fields: [questionId], references: [id], onDelete: Cascade)
  team         Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user         User?          @relation(fields: [userId], references: [id])

  @@unique([questionId, teamId])
  @@index([questionId])
  @@index([teamId])
  @@index([userId])
}

model Submission {
  id            String            @id @default(uuid())
  questionId    String
  userId        String
  teamId        String
  code          String            @db.Text
  language      String
  testsPassed   Int               @default(0)
  totalTests    Int
  points        Int               @default(0)
  executionTime Float?
  memory        Float?
  error         String?           @db.Text
  submittedAt   DateTime          @default(now())
  compileOutput String?           @db.Text
  completedAt   DateTime?
  mode          SubmissionMode    @default(SUBMIT)
  verdict       SubmissionVerdict @default(PENDING)
  question      Question          @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  testResults   TestCaseResult[]

  @@index([questionId])
  @@index([userId])
  @@index([teamId])
  @@index([submittedAt])
  @@index([verdict])
  @@index([userId, questionId])
}

model TestCaseResult {
  id            String     @id @default(uuid())
  submissionId  String
  testCaseId    String
  status        String
  executionTime Float?
  memory        Float?
  output        String?    @db.Text
  error         String?    @db.Text
  judge0Token   String?
  createdAt     DateTime   @default(now())
  submission    Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  testCase      TestCase   @relation(fields: [testCaseId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([testCaseId])
  @@index([status])
}

model RefreshToken {
  id         String   @id @default(uuid())
  token      String   @db.Text
  userId     String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  revoked    Boolean  @default(false)
  deviceInfo String?  @db.Text
  ipAddress  String?
  lastActive DateTime @default(now())
  tokenHash  String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
}

model QuestionRequest {
  id          String                @id @default(uuid())
  questionId  String
  teamId      String
  requesterId String
  status      QuestionRequestStatus @default(PENDING)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  question    Question              @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([questionId, teamId, requesterId])
  @@index([questionId])
  @@index([teamId])
  @@index([requesterId])
  @@index([status])
}

model QuestionTemplate {
  id           String   @id @default(uuid())
  questionId   String
  language     String
  headerCode   String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  boilerplate  String?  @db.Text
  diagram      String?  @db.Text
  mainFunction String   @db.Text
  userFunction String   @db.Text
  definition   String?  @db.Text
  question     Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([questionId, language])
  @@index([questionId])
}

enum Role {
  USER
  TEAM_LEADER
  ADMIN
  ROOM_ADMIN
}

enum RoomStatus {
  WAITING
  ACTIVE
  COMPLETED
}

enum RoomVisibility {
  PUBLIC
  PRIVATE
}

enum TeamVisibility {
  PUBLIC
  PRIVATE
}

enum ParticipantStatus {
  ACTIVE
  LEFT
  KICKED
}

enum QuestionStatus {
  UNASSIGNED
  ASSIGNED
  SOLVED
}

enum JoinRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum SubmissionVerdict {
  PENDING
  ACCEPTED
  WRONG_ANSWER
  TIME_LIMIT_EXCEEDED
  MEMORY_LIMIT_EXCEEDED
  RUNTIME_ERROR
  COMPILATION_ERROR
  PRESENTATION_ERROR
  INTERNAL_ERROR
}

enum SubmissionMode {
  RUN
  SUBMIT
}

enum TestCaseCategory {
  BASIC
  EDGE
  LARGE
  SPECIAL
  CORNER
  INVALID
  HIDDEN
}

enum QuestionRequestStatus {
  PENDING
  APPROVED
  REJECTED
}
